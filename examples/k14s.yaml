images:
- location: "https://cloud-images.ubuntu.com/xenial/20211001/xenial-server-cloudimg-amd64-uefi1.img"
  arch: "x86_64"
  digest: "sha256:65bb42c0d2e039aec5168a861b2c37deb641e9ce9ba1a79a90c60b6c34ce907f"
- location: "https://cloud-images.ubuntu.com/xenial/20211001/xenial-server-cloudimg-arm64-uefi1.img"
  arch: "aarch64"
  digest: "sha256:282ff9bd3cae921470f27f626eb7deaf1da2cea24dd2e96102b0b764cd5019f2"

# Mounts are disabled in this template, but can be enabled optionally.
mounts: []
containerd:
  system: false
  user: false

# <https://github.com/spurin/kubernetes-v1.0-lab/blob/main/tutorial.md>
provision:
- mode: boot
  script: |
   printf '#!/bin/sh\nif [ "$2" = "enable" -a "$3" = "--now" ]; then /bin/systemctl $1 enable $4; /bin/systemctl $1 start $4; else /bin/systemctl "$@"; fi\n' >/usr/local/bin/systemctl
   chmod 755 /usr/local/bin/systemctl
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    command -v docker >/dev/null 2>&1 && exit 0
    apt-get install -y docker.io
    systemctl restart docker.service
    usermod -aG docker {{.User}}
- mode: system
  script: |
    #!/bin/bash
    command -v etcd >/dev/null 2>&1 && exit 0
    version=2.2.1
    case $(uname -m) in
      x86_64)   arch=amd64;;
      aarch64)  arch=arm64;;
    esac
    curl -L https://github.com/coreos/etcd/releases/download/v$version/etcd-v$version-linux-$arch.tar.gz -O
    tar xzvf etcd-v$version-linux-$arch.tar.gz
    sudo install etcd-v$version-linux-$arch/etcd /usr/local/bin
- mode: system
  script: |
    #!/bin/bash
    etcd --listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://localhost:2379 &> /var/log/etcd.log &
- mode: system
  script: |
    #!/bin/bash
    command -v kubelet >/dev/null 2>&1 && exit 0
    version=1.4.0
    case $(uname -m) in
      x86_64)   arch=amd64;;
      aarch64)  arch=arm64;;
    esac
    curl -L https://storage.googleapis.com/kubernetes-release/release/v$version/kubernetes-server-linux-$arch.tar.gz -O
    tar zxvf kubernetes-server-linux-$arch.tar.gz
    sudo install kubernetes/server/bin/kubectl /usr/local/bin
    sudo install kubernetes/server/bin/kube-apiserver /usr/local/bin
    sudo install kubernetes/server/bin/kube-controller-manager /usr/local/bin
    sudo install kubernetes/server/bin/kube-proxy /usr/local/bin
    sudo install kubernetes/server/bin/kube-scheduler /usr/local/bin
    sudo install kubernetes/server/bin/kubelet /usr/local/bin
- mode: system
  script: |
    #!/bin/bash
    kube-apiserver --etcd-servers=http://localhost:2379 --service-cluster-ip-range=10.0.0.0/16 --bind-address=0.0.0.0 --insecure-bind-address=0.0.0.0 &> /var/log/kube-apiserver.log &
    kubelet --api-servers=http://localhost:8080 --pod-infra-container-image="registry.k8s.io/pause:0.8.0" &> /var/log/kubelet.log &
    kube-scheduler --master=http://localhost:8080 &> /var/log/kube-scheduler.log &
    kube-controller-manager --master=http://localhost:8080 &> /var/log/kube-controller-manager.log &
    kube-proxy --master=http://localhost:8080 &> /var/log/kube-proxy.log &
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    export KUBECONFIG=/root/.kube/config
    name=k8s-v1.4
    kubectl config set-cluster $name --server=http://localhost:8080
    kubectl config set-context $name --cluster=$name
    kubectl config use-context $name
    kubectl config view
    mkdir -p {{.Home}}/.kube
    cp -f $KUBECONFIG {{.Home}}/.kube/config
    chown -R {{.User}} {{.Home}}/.kube
probes:
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 30s bash -c "until command -v docker >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "docker is not installed yet"
      exit 1
    fi
    if ! timeout 30s bash -c "until pgrep docker; do sleep 3; done"; then # NOTE: docker -d
      echo >&2 "dockerd is not running"
      exit 1
    fi
  hint: See "/var/log/cloud-init-output.log". in the guest
- script: |
    #!/bin/bash
    set -eux -o pipefail
    if ! timeout 300s bash -c "until test -f ~/.kube/config; do sleep 3; done"; then
      echo >&2 "k8s is not running yet"
      exit 1
    fi
    if ! timeout 300s bash -c "until kubectl version >/dev/null 2>&1; do sleep 3; done"; then
      echo >&2 "kubernetes cluster is not up and running yet"
      exit 1
    fi
  hint: |
    The k8s kubeconfig file has not yet been created.
portForwards:
- guestSocket: "/var/run/docker.sock"
  hostSocket: "{{.Dir}}/sock/docker.sock"
copyToHost:
- guest: "{{.Home}}/.kube/config"
  host: "{{.Dir}}/copied-from-guest/kubeconfig.yaml"
  deleteOnStop: true
message: |
  To run `docker` on the host (assumes docker-cli is installed), run the following commands:
  ------
  export DOCKER_HOST="unix://{{.Dir}}/sock/docker.sock"
  docker ...
  ------
  To run `kubectl` on the host (assumes kubectl is installed), run the following commands:
  ------
  export KUBECONFIG="{{.Dir}}/copied-from-guest/kubeconfig.yaml"
  kubectl ...
  ------
